# Microservice Architecture

## 1. Архитектурные принципы и структура

В основе проектирования системы лежат следующие паттерны и принципы, обеспечивающие масштабируемость и слабую связность компонентов:

* **Clean Architecture (Чистая архитектура):** Соблюдение четкого разделения ответственности по слоям (*API, Application, Domain, Infrastructure*). Это позволяет изолировать бизнес-логику от деталей реализации внешних интерфейсов и баз данных.
* **Event-Driven Architecture (EDA):** Взаимодействие между модулями осуществляется асинхронно через брокер сообщений, что снижает прямую зависимость компонентов друг от друга.
* **Saga Pattern (Orchestration):** Управление распределенными транзакциями и сложными бизнес-процессами реализовано через оркестрацию на базе конечных автоматов.

## 2. Реализация коммуникации и логики

Все компоненты системы функционируют в рамках единого хоста (`SchedulePlanner.Api`), что упрощает развертывание, однако логически они полностью изолированы друг от друга. Взаимодействие организовано по двум основным каналам:

* **Асинхронное взаимодействие:** Используется брокер сообщений **RabbitMQ** в связке с библиотекой **MassTransit**. Это основной канал для событийной модели (Pub/Sub) и асинхронной обработки команд.
* **Синхронное взаимодействие (RPC):** Реализован механизм удаленного вызова процедур (*Remote Procedure Call*) через RabbitMQ. Данный подход используется для сценариев, требующих синхронного получения ответа, и выступает в качестве альтернативы прямым HTTP-запросам между сервисами.

## 3. Описание ключевого бизнес-процесса (Event Creation Saga)

Центральным элементом системы является процесс создания события, который демонстрирует практическую реализацию паттерна **Saga** (на основе State Machine).

Процесс оркестрируется компонентом `EventCreationSaga` и гарантирует целостность данных через следующую последовательность шагов:

![Схема архитектуры](https://github.com/Suppyour/microservice-architecture/blob/main/SchedulePlanner.png?raw=true)
*(Схема взаимодействия компонентов в рамках EventCreationSaga)*

1.  **Инициализация:** Клиент отправляет запрос через REST API. Система инициализирует экземпляр Саги.
2.  **Валидация (Validation):** Сага отправляет команду `ValidateUser`. Компонент `ValidateUserConsumer` выполняет проверку данных пользователя и возвращает результат (`UserValidated`).
3.  **Резервирование (Reservation):** При успешной валидации инициируется процесс резервирования временного слота через команду `ReserveTimeSlot`.
4.  **Создание (Persistance):** После подтверждения резерва отправляется команда на физическое создание задачи в базе данных (`CreateTask`).
5.  **Уведомление (Notification):** Финальный этап успешного сценария — отправка уведомления пользователю через команду `SendNotification`.

## System Design

## 4. Функциональные требования
Система предназначена для управления расписанием задач с использованием событийно-ориентированной архитектуры.
1.  **Создание события (Task)**: Пользователь должен иметь возможность создать задачу с заголовком, описанием, сроком выполнения и категорией.
2.  **Валидация пользователя**: Перед созданием задачи система должна проверить существование и статус пользователя (через `UserService`).
3.  **Резервирование времени**: Система должна проверять и резервировать временной слот в календаре пользователя, чтобы избежать конфликтов.
4.  **Фоновая обработка (Saga)**: Процесс создания должен быть асинхронным и отказоустойчивым (если резервирование не удалась — отменить создание).
5.  **Отправка уведомлений**: После успешного создания задачи пользователю должно прийти уведомление (Email/Push).
6.  **Просмотр задач**: Пользователь может просматривать список своих задач.
7.  **Интеграция с внешними сервисами**: Система поддерживает синхронные (RPC) и асинхронные вызовы для обмена данными с другими подсистемами.

## 5. Сервисы и ответственность

| Сервис | Тип | Ответственность |
| :--- | :--- | :--- |
| **SchedulePlanner** | Оркестратор | Основной API, управление Сагами (`EventCreationSaga`), координация. |
| **UserService** | Домен | Управление пользователями, авторизация. |
| **TaskService** | Домен | CRUD операции над задачами (`ScheduleTask`). |
| **TimeSlotService** | Домен | Управление календарем, проверка пересечений. |
| **NotificationService** | Инфраструктура | Отправка сообщений пользователям. |

*   **User**: Пользователь системы. Имеет коллекцию задач.
*   **ScheduleTask**: Основная единица работы. Привязана к Пользователю и Категории.
*   **Category**: Группировка задач (например, "Работа", "Дом").

## 6. REST Эндпоинты

| Метод | URL | Описание | Тело запроса / Параметры | Ответ |
| :--- | :--- | :--- | :--- | :--- |
| `POST` | `/api/Tasks` | Синхронное создание задачи | `CreateTaskDto` | `ScheduleTask` |
| `POST` | `/api/Tasks/saga` | **Асинхронное** создание (Сага) | `CreateTaskDto` | `202 Accepted` |
| `GET` | `/api/Tasks/user/{userId}` | Получить задачи пользователя | `userId` (Guid) | `List<ScheduleTask>` |
| `GET` | `/api/Integration/rpc-test` | Тест RPC вызова | `?message=...` | JSON с ответом |
